\chapter{Auxiliary code}
\label{apdx:sec:tools}

Below is the set of auxiliary Python scripts that assisted throughout various part of the application's development.

\section{CAN Speed}

Calculates the average number of packets per second in the CSV file.

\begin{lstlisting}[language=Python]
import argparse
import can

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("dataset", help="Path to CSV file.")
    args = parser.parse_args()

    timestamps = list(map(lambda msg: msg.timestamp, list(can.BLFReader(args.dataset))))

    diffs = []
    for i in range(0, len(timestamps) - 1):
        diffs.append(timestamps[i + 1] - timestamps[i])
    
    print(f"{1 / (sum(diffs) / len(diffs)):.3f} packets/s")
\end{lstlisting}

\section{Feature Selection}

Outputs a graph showing correlation between features.

\begin{lstlisting}[language=Python]
import argparse
import pandas
import matplotlib.pyplot as plt
import seaborn
from pathlib import Path

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("dataset", help="Path to CSV file.")
    args = parser.parse_args()
    dataset = pandas.read_csv(args.dataset)
    plt.figure(figsize=(15, 10))
    seaborn.heatmap(dataset.corr(), annot=True)
    plt.savefig(f"graphs/{Path(args.dataset).stem}.png")
\end{lstlisting}

\section{Get IDs}

Get set of IDs in file.

\begin{lstlisting}[language=Python]
import argparse
import pandas

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("dataset", help="Path to CSV file.")
    parser.add_argument("--attack", action="store_true", help="Filter IDs that are attacked.")
    args = parser.parse_args()
    dataframe = pandas.read_csv(parser.parse_args().dataset)
    if args.attack:
        ids = dataframe.loc[dataframe.iloc[:, -2] == "Attack"].iloc[:, 1].unique()
        ids.sort()
        print(f"There are {len(ids)} unique IDs targeted for attacks: {ids}")
    else:
        ids = dataframe.iloc[:, 1].unique()
        ids.sort()
        print(f"There are {len(ids)} unique IDs: {ids}")
\end{lstlisting}

\section{Graph features}

Graphs the features extracted by the \gls{ids}.

\begin{lstlisting}[language=Python]
import argparse
from pathlib import Path
import pandas as pd
import matplotlib.pyplot as plt
from matplotlib.lines import Line2D
import numpy as np

def label_to_color_alt(label):
    match label:
        case 0 | 2:
            return 'g'
        case 1 | 3:
            return 'b'

def label_to_color(label):
    match label:
        case 0:
            return 'g'
        case 1:
            return 'b'
        case 2:
            return 'y'
        case 3:
            return 'r'

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("dataset", nargs="*", help="Path to CSV file.")
    parser.add_argument("--threed", action='store_true', help="Make a 3d scatterplot.")
    parser.add_argument("--nolabel", action='store_true', help="Ignore labels.")
    args = parser.parse_args()
    Path("graphs").mkdir(exist_ok=True)
    for path in args.dataset:
        Path(f"graphs/{Path(path).stem}").mkdir(exist_ok=True)
        dataset = pd.read_csv(path)
        if args.threed:
            fig = plt.figure()
            ax = fig.add_subplot(projection='3d')
            ax.set_xlabel("AvgTime")
            ax.set_ylabel("Entropy")
            ax.set_zlabel("HammingDist")
            ax.scatter(dataset["AvgTime"], dataset["Entropy"], dataset["HammingDist"], c = dataset["Label"].apply(label_to_color_alt if args.nolabel else label_to_color).values if "Label" in dataset else "c")
            plt.savefig(f"graphs/{Path(path).stem}.png")
        for col in dataset:
            if col != "Label":
                fig, ax = plt.subplots()
                fig.set_size_inches(20, 5)
                ax.set_xlabel("Window")
                ax.scatter(np.arange(0, len(dataset[col])), dataset[col], c = dataset["Label"].apply(label_to_color_alt if args.nolabel else label_to_color).values if "Label" in dataset else "c")
                if col == "AvgTime":
                    ax.set_ylabel("Average Time")
                    ax.set_title("Average Time Between Packets of the Same ID")
                elif col == "Entropy":
                    ax.set_ylabel(col)
                    ax.set_title("Average Entropy of Packets of the Same ID")
                elif col == "HammingDist":
                    ax.set_ylabel("Hamming Distance")
                    ax.set_title("Average Hamming Distance of Packets of the Same ID")
                if "Label" in dataset:
                    if not args.nolabel:
                        legend_elements = [Line2D([0], [0], marker='o', color='w', label='True positive', markerfacecolor='g', markersize=15),
                                        Line2D([0], [0], marker='o', color='w', label='True negative', markerfacecolor='b', markersize=15),
                                        Line2D([0], [0], marker='o', color='w', label='False positive', markerfacecolor='y', markersize=15),
                                        Line2D([0], [0], marker='o', color='w', label='False negative', markerfacecolor='r', markersize=15)]
                    else:
                        legend_elements = [Line2D([0], [0], marker='o', color='w', label='Alert', markerfacecolor='g', markersize=15),
                                        Line2D([0], [0], marker='o', color='w', label='No alert', markerfacecolor='b', markersize=15)]
                    ax.legend(handles=legend_elements)
                fig.savefig(f"graphs/{Path(path).stem}/{col}.png")
\end{lstlisting}

\section{Locate attack types}

Locate attack types on the IEEE challenge dataset.

\begin{lstlisting}[language=Python]
import argparse
import pandas

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("dataset", nargs="*", help="Path to CSV file.")
    args = parser.parse_args()

    for path in args.dataset:
        dataframe = pandas.read_csv(path)
        dataframe = dataframe.loc[dataframe["label"] == "Attack"]
        last_attack = dataframe.iloc[0][-1]
        last_timestamp = dataframe.iloc[0]["timestamp"]
        start = last_timestamp
        end = 0

        for _, row in dataframe.iterrows():
            if row["class"] != last_attack:
                end = last_timestamp
                print(f"{last_attack} occurs from {start} to {end}")
                start = row["timestamp"]
                last_attack = row["class"]
            last_timestamp = row["timestamp"]
\end{lstlisting}

\section{Log to CSV}

Convert CANDump format to \gls{csv}.

\begin{lstlisting}[language=Python]

import argparse
import re
from pathlib import Path

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("dataset", help="Path to CSV file.")
    args = parser.parse_args()

    with open(args.dataset, "r") as file:
        content = file.read()
        content = re.sub("\(", '', content, flags=re.M)
        content = re.sub("\) slcan0 ", ',', content, flags=re.M)
        content = re.sub(f"#(?=[0-9A-Z]{{16}})", ",8,", content, flags=re.M)
        content = re.sub(f"#(?=[0-9A-Z]{{14}})", ",7,", content, flags=re.M)
        content = re.sub(f"#(?=[0-9A-Z]{{12}})", ",6,", content, flags=re.M)
        content = re.sub(f"#(?=[0-9A-Z]{{10}})", ",5,", content, flags=re.M)
        content = re.sub(f"#(?=[0-9A-Z]{{8}})", ",4,", content, flags=re.M)
        content = re.sub(f"#(?=[0-9A-Z]{{6}})", ",3,", content, flags=re.M)
        content = re.sub(f"#(?=[0-9A-Z]{{4}})", ",2,", content, flags=re.M)
        content = re.sub(f"#(?=[0-9A-Z]{{2}})", ",1,", content, flags=re.M)
        content = re.sub(f"(?<=,[0-9A-Z]{{1}},[0-9A-Z]{{2}})(?=[^,])", ',', content, flags=re.M)
        for _ in range(8):
            content = re.sub(f"(?<=,[0-9A-Z]{{2}},[0-9A-Z]{{2}})(?=[^,\n])", ',', content, flags=re.M)
        content = re.sub('\n', ",Normal\n", content, flags=re.M)
        content = re.sub(",,", ",", content, flags=re.M)
        with open("datasets/replaced.csv", "w") as out:
            out.write("timestamp,id,dlc,data0,data1,data2,data3,data4,data5,data6,data7,label\n" + content)
\end{lstlisting}

\section{Powerdraw plot}

Plot power consumption readings from \gls{csv} file.

\begin{lstlisting}[language=Python]
import argparse
from pathlib import Path
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from matplotlib.pyplot import figure

def main():
    parser = argparse.ArgumentParser()
    parser.add_argument("dataset", help="Path to CSV file.")
    args = parser.parse_args()
    Path("graphs").mkdir(exist_ok=True)
    dataframe = pd.read_csv(args.dataset)
    figure(figsize=(20, 5))
    plt.plot(np.arange(0, dataframe.shape[0]), dataframe["Current(mA)"])
    plt.xlabel("Record")
    plt.ylabel("Current (mA)")
    plt.savefig("graphs/powerdraw.png")
\end{lstlisting}